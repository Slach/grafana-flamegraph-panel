{"version":3,"sources":["../src/flame_graph_ctrl.js"],"names":["MetricsPanelCtrl","_","d3","panelDefaults","mapping","signatureFieldName","signatureSeparator","panelMargin","left","right","top","bottom","panelWidth","panelHeight","availableColorFunctions","colorFunction","colorModuleColumnName","colorSingle","FlameGraphCtrl","$scope","$injector","onInitEditMode","panels","grafanaBootData","settings","thisPanel","pluginId","thisPanelPath","baseUrl","editorPath","addEditorTab","onDataError","err","onDataReceived","dataList","data","map","tableHandler","bind","length","tree","setValues","render","getColumnId","columnName","i","columns","text","setValueRec","signature","value","currentPart","shift","children","name","push","Object","keys","reduce","acc","current","split","panel","tableData","columnIdSignature","columnIdValue","console","error","Error","message","rows","JSON","stringify","colorFunction_random","colorFunction_single","colorFunction_module","colorFunction_scale","setFrameColor","colorFunctions","onRender","onRenderComplete","renderingCompleted","link","scope","elem","attrs","ctrl","flameGraph","$flamegraph","find","height","width","events","on","setFlamegraphSize","cellHeight","transitionDuration","transitionEase","easeCubic","sort","title","select","datum","call","resetZoom","emit","row","isString","parseInt","replace","css","Math","floor","e","defaultsDeep","templateUrl"],"mappings":"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","file":"flame_graph_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\n\nimport _ from 'lodash';\nimport * as d3 from './d3_bundle';\n\nimport './external/d3.flameGraph.css!';\nimport './css/flame-graph-panel.css!';\n\nconst panelDefaults = {\n  mapping: {\n    signatureFieldName: 'signature',\n    signatureSeparator: '#',\n  },\n\n  panelMargin: {\n    left: 35,\n    right: 35,\n    top: 10,\n    bottom: 20\n  },\n\n  panelWidth: null,\n  panelHeight: 500,\n\n  // fixed: fixed color\n  // module: based on a column name\n  // random: hashColor() function from d3.flameGraph lib\n  // scale depending of the height\n  availableColorFunctions: ['random', 'fixed', 'module', 'scale'],\n  colorFunction: 'random',\n  colorModuleColumnName: 'module',\n  colorSingle: '#C05018',\n};\n\nexport class FlameGraphCtrl extends MetricsPanelCtrl {\n  static templateUrl = 'module.html';\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    _.defaultsDeep(this.panel, panelDefaults);\n\n    this.events.on('data-received', this.onDataReceived);\n    this.events.on('data-snapshot-load', this.onDataReceived);\n    this.events.on('init-edit-mode', this.onInitEditMode);\n    this.events.on('data-error', this.onDataError);\n\n    this.events.on('render', this.onRender);\n    // custom event from link -> render()\n    this.events.on('render-complete', this.onRenderComplete)\n  }\n\n  onInitEditMode = () => {\n    // determine the path to this plugin\n    let panels = grafanaBootData.settings.panels;\n    let thisPanel = panels[this.pluginId];\n    let thisPanelPath = thisPanel.baseUrl + '/';\n    // add the relative path to the editor\n    let editorPath = thisPanelPath + 'editor.html';\n\n    this.addEditorTab('Options', editorPath, 2);\n  };\n\n  onDataError = (err) => {\n    this.onDataReceived([]);\n  };\n\n  onDataReceived = (dataList) => {\n    const data = dataList.map(this.tableHandler.bind(this));\n    if (!data || data.length === 0) {\n      return;\n    }\n\n    this.tree = this.setValues(data[0]);\n    this.render();\n  };\n\n\n  getColumnId = (data, columnName) => {\n    for (let i = 0; i < data.columns.length; i++) {\n      if (data.columns[i].text === columnName)\n        return i;\n    }\n    return null;\n  };\n\n  setValueRec = (tree, signature, value) => {\n    // `signature` is the current node\n    if (signature.length == 0) {\n      tree.value = value;\n      return tree;\n    }\n\n    const currentPart = signature[0];\n    signature.shift();\n\n    // already existing children\n    for (let i = 0; i < tree.children.length; i++) {\n      if (tree.children[i].name === currentPart)\n        return this.setValueRec(tree.children[i], signature, value);\n    }\n\n    // new children\n    tree.children.push(this.setValueRec({name: currentPart, value: value, children: []}, signature, value));\n    return tree;\n  };\n\n  setValues = (data) => {\n    let tree = Object.keys(data).reduce(((acc, current) => {\n      // in case of data based on time (round)\n      if (data[current] == 0) {\n        data[current] = 1;\n      }\n      this.setValueRec(\n        acc,\n        current.split(this.panel.mapping.signatureSeparator),\n        data[current]\n      );\n      return acc;\n    }).bind(this), {name: 'root', value: 1, children: []});\n    return tree;\n  };\n\n  tableHandler = (tableData) => {\n    const columnIdSignature = this.getColumnId(tableData, this.panel.mapping.signatureFieldName);\n    const columnIdValue = this.getColumnId(tableData, 'Value');\n\n    if (columnIdSignature == null || columnIdValue == null) {\n      console.error('columns:', tableData.columns);\n      console.error('signature column name:', this.panel.mapping.signatureFieldName);\n      const error = new Error();\n      error.message = 'No data or malformed series';\n      error.data = 'Metric query returns ' + tableData.rows.length +\n        ' series. FlameGraph Panel expects at least 1 serie with signature column.\\n\\nResponse:\\n' + JSON.stringify(tableData);\n      throw error;\n    }\n\n    return tableData.rows.reduce((acc, current) => {\n      const signature = current[columnIdSignature];\n      if (acc[signature] == null)\n        acc[signature] = current[columnIdValue];\n      else\n        acc[signature] += current[columnIdValue];\n      // DEBUG\n      // acc[signature] = 1;\n      return acc;\n    }, {});\n  };\n\n  colorFunction_random = () => {\n  };\n\n  colorFunction_single = () => {\n  };\n\n  colorFunction_module = () => {\n  };\n\n  colorFunction_scale = () => {\n  };\n\n  setFrameColor = () => {\n    const colorFunctions = {\n      'random': colorFunction_random,\n      'single': colorFunction_single,\n      'module': colorFunction_module,\n      'scale': colorFunction_scale,\n    };\n    if (colorFunctions[this.colorFunction])\n      colorFunctions[this.colorFunction]();\n  };\n\n  onRender = () => {\n    if (typeof this.tree == 'undefined') {\n      return;\n    }\n  };\n\n  onRenderComplete = (data) => {\n    this.panel.panelWidth = data.panelWidth;\n    this.renderingCompleted();\n  };\n\n\n  link = (scope, elem, attrs, ctrl) => {\n    // D3 object\n    let flameGraph;\n    // jQuery object\n    let $flamegraph = elem.find('.flame-graph-panel');\n    let height, width;\n\n    ctrl.events.on('render', () => {\n      render();\n    });\n\n\n    function render() {\n      if (!ctrl.tree || !setFlamegraphSize()) {\n        return;\n      }\n      if (!flameGraph) {\n        flameGraph = d3.flameGraph(d3)\n          .width(width)\n          .height(height)\n          .cellHeight(16)\n          .transitionDuration(500)\n          .transitionEase(d3.easeCubic)\n          .sort(true)\n          .title(\"\");\n      } else {\n        flameGraph.width(width).height(height)\n      }\n\n      d3.select(\"#chart\")\n        .datum(ctrl.tree)\n        .call(flameGraph);\n\n      flameGraph.resetZoom();\n\n      ctrl.events.emit('render-complete', {\n        \"panelWidth\": width\n      });\n    }\n\n    function setFlamegraphSize() {\n      try {\n        height = ctrl.height || ctrl.panel.height || ctrl.row.height;\n        if (_.isString(height)) {\n          height = parseInt(height.replace('px', ''), 10);\n        }\n        $flamegraph.css('height', height + 'px');\n\n        height = Math.floor($flamegraph.height()) - (ctrl.panel.panelMargin.top + ctrl.panel.panelMargin.bottom);\n        width = Math.floor($flamegraph.width()) - (ctrl.panel.panelMargin.left + ctrl.panel.panelMargin.right);\n\n        return true;\n      } catch (e) { // IE throws errors sometimes\n        return false;\n      }\n    }\n\n  };\n}\n\n\n"]}